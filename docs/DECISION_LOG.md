# Decision Journal

## Architecture
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Stay on a Frappe Desk-only UI for the current release | Platform architecture for internal hospitality operations users while assessing consolidation options | Chose Frappe Desk over building a separate SPA now to leverage native DocType tooling, accelerate delivery, and keep maintenance focused (`04-Separate-Frontend.md` documents migration path if external portals become mandatory) | All workflows, permissions, and docs assume Desk UX; any customer-facing portal or mobile-first requirement triggers SPA evaluation. Status: Active, review during consolidation planning | Frappe Framework v15 Desk runtime | 2025-11-08 | docs/README.md; docs/00-ARCHITECTURE/01-App-Structure.md; docs/00-ARCHITECTURE/04-Separate-Frontend.md |
| Keep every business entity as a first-class DocType inside `blkshp_os` (no ERPNext dependency) | Data model ownership for standalone deployability | Selected in-app DocTypes instead of reusing ERPNext masters to avoid hard dependencies, simplify packaging, and ensure migrations run on benches that only install BLKSHP OS | Requires duplicating masters (e.g. Vendor, Storage) within domains; consolidation work must map or reconcile overlapping masters across projects. Status: Active | Frappe DocType system | 2025-11-08 | docs/00-ARCHITECTURE/01-App-Structure.md |
| Organize backend by domain modules with a shared API layer | Codebase structure and service boundaries | Adopted domain-based modules + whitelisted API endpoints instead of a monolithic `controllers` package to mirror business pillars and keep cross-domain contracts explicit | Facilitates incremental consolidation (modules can be swapped or merged independently) but enforces shared patterns (tests, services, whitelisted APIs) across teams. Status: Active | Frappe module system; whitelisted API mechanism | 2025-11-08 | docs/00-ARCHITECTURE/01-App-Structure.md; docs/CROSS-DOMAIN-REFERENCE.md |
| Ship standard roles and custom fields via fixtures | Environment setup repeatability | Exported fixtures chosen over manual setup to guarantee identical permissions and user extensions across benches, critical for automation and AI agents | Any schema change to user/role fields must update fixtures; consolidation tooling must reconcile fixture collisions. Status: Active | Frappe fixture loader | 2025-11-08 | docs/00-ARCHITECTURE/01-App-Structure.md; fixtures/standard_roles.json |

## Departments Domain
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Treat Departments as the foundational segmentation layer across all domains | Need to replace Craftable’s multi-platform segmentation with a single model | Chose department-centric organization instead of standalone product catalogs per vertical to unify reporting, permissions, and inventory math | Every domain records `department` and filters by user access; consolidation must honor department mappings. Status: Active | Department DocType; department permission service | 2025-11-08 | docs/README.md; docs/02-DEPARTMENTS/README.md; docs/CROSS-DOMAIN-REFERENCE.md |
| Allow products to belong to multiple departments via `Product Department` child table | Product allocation requirements | Adopted many-to-many allocations over single-department ownership so shared items (e.g. flour) can be managed centrally | Inventory balance, procurement splits, and recipe costing expect multi-department associations; consolidation must merge duplicate allocation schemes carefully. Status: Active | Product DocType; Product Department child table | 2025-11-08 | docs/02-DEPARTMENTS/README.md; docs/01-PRODUCTS/01-Product-Master.md |
| Manage department access on the User DocType with granular CRUD flags | Access control granularity | Added `department_permissions` child table instead of coarse role gating to let users mix read/write/create/delete per department | All queries rely on these flags; consolidation with other RBAC systems must translate to the same CRUD semantics. Status: Active | User DocType; Department Permission child table; UserPermissionMixin | 2025-11-08 | docs/02-DEPARTMENTS/02-Department-Permissions.md; docs/11-PERMISSIONS/README.md |

## Permissions Domain
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Maintain a catalog of 70+ atomic permissions grouped into eight standard roles | Security baseline | Opted for fine-grained permissions plus baseline roles rather than coarse role bundles to enable least-privilege department operations | Downstream services (API checks, UI controls) assume atomic permission IDs; consolidation must map or extend this registry to avoid gaps. Status: Active | Permission registry (`constants.py`); Role & User services | 2025-11-08 | docs/README.md; docs/11-PERMISSIONS/README.md |
| Extend the Frappe User DocType with `UserPermissionMixin` and custom fields | Enforcement mechanics | Embedded mixin chosen over separate permission service so native Frappe permission checks automatically respect department logic | Any alternate user management (e.g. ERPNext users) must load the mixin or recreate equivalent hooks. Status: Active | Frappe `hooks.py` extend_doctype_class; department permission child table | 2025-11-08 | docs/00-ARCHITECTURE/01-App-Structure.md; docs/11-PERMISSIONS/README.md |
| Plan Okta SSO integration for user provisioning | Stakeholder requirement for enterprise access | Documented Okta SSO instead of deferring identity entirely to highlight enterprise expectation even though implementation is pending | Consolidation with suites that already manage SSO must reconcile flows; Status: Pending implementation, decision stands for roadmap | External IdP (Okta); Frappe OAuth hooks | 2025-11-08 | docs/11-PERMISSIONS/README.md |

## Products Domain
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Use a single Product DocType for all item types | Product master strategy | Selected unified product master over separate food/beverage/supplies catalogs to eliminate duplication seen in legacy Craftable stack | All downstream domains (inventory, procurement, recipes) expect one canonical product; consolidation must consolidate or alias existing masters. Status: Active | Product DocType; Department allocations | 2025-11-08 | docs/README.md; docs/01-PRODUCTS/01-Product-Master.md |
| Adopt hub-and-spoke unit conversion with primary count unit storage | Quantity normalization | Chose hub model over direct pairwise conversions to ensure consistent math and avoid conversion drift | All inventory, procurement, and recipe calculations store quantities in primary unit; breaking this assumption risks mismatched theoretical counts. Status: Active | Product conversion methods; primary_count_unit field | 2025-11-08 | docs/01-PRODUCTS/04-Unit-Conversion-System.md |
| Require all domains to call shared product conversion helpers (no ad-hoc math) | Cross-domain consistency | Standardized on `convert_to_primary_unit` / `convert_from_primary_unit` instead of custom math to prevent rounding divergence | Consolidation must inspect other projects for duplicated conversion logic and refactor to use shared helpers. Status: Active | Product conversion service; cross-domain reference patterns | 2025-11-08 | docs/CROSS-DOMAIN-REFERENCE.md; docs/01-PRODUCTS/04-Unit-Conversion-System.md |
| Flag product properties (generic, non-inventory, prep) to drive behavior | Product categorization | Embedded flags instead of separate DocTypes to keep a single record authoritative while still influencing domain workflows | Inventory/recipes interpret these flags when deciding workflow eligibility; consolidation must preserve semantics when merging item catalogs. Status: Active | Product DocType fields | 2025-11-08 | docs/01-PRODUCTS/01-Product-Master.md |

## Inventory Domain
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Track inventory using a 2D Product + Department model, storing quantities in primary unit | Inventory architecture | Selected 2D model with primary unit storage instead of storage-location buckets to simplify math and align with department-centric operations | All balances, audits, reports, and theoretical calculations rely on this assumption; consolidation with systems using location-based 3D models will require translation layers. Status: Active | Inventory Balance DocType; Product conversion helpers | 2025-11-08 | docs/README.md; docs/03-INVENTORY/01-Inventory-Balance.md; docs/CROSS-DOMAIN-REFERENCE.md |
| Treat storage areas as metadata for organization, not as inventory buckets | Storage design | Rejected storage-based inventory (3D model) to avoid splitting quantities and to keep counts aggregated per department while still guiding counting tasks | Counting tasks and reports use storage for UI only; any migration from systems that use bin-level balances must aggregate during consolidation. Status: Active | Storage Area DocType; Inventory Balance model | 2025-11-08 | docs/03-INVENTORY/08-Storage-Areas.md; docs/CROSS-DOMAIN-REFERENCE.md |
| Calculate theoretical inventory as last audit +/- transactions | Variance analysis method | Preferred audit-anchor formula over continuous running totals to maintain audit accountability and align with restaurant best practices | Requires regular audits and accurate transaction feeds; missing audits or delayed integrations create variance drift. Status: Active | Inventory Audit DocType; procurement/transfer/depletion feeds | 2025-11-08 | docs/03-INVENTORY/02-Theoretical-Inventory.md |
| Run audits through a multi-stage workflow with counting tasks | Operational workflow | Implemented Setup→Locked workflow with task generation instead of ad-hoc audits to distribute counting workload and support approvals | Downstream analytics and permissions assume workflow states; consolidating with systems using simpler audit flows requires mapping states. Status: Active | Inventory Audit DocType; Counting Task DocType; department permissions | 2025-11-08 | docs/03-INVENTORY/03-Inventory-Audits.md; docs/03-INVENTORY/04-Counting-Tasks.md |
| Enforce unique inventory balance per product-department-company | Data integrity | Added unique constraint instead of allowing duplicates to prevent double-counting and keep 2D model consistent | Any migration scripts must de-duplicate prior to insert; consolidation with location-based systems must roll up to unique tuples. Status: Active | Inventory Balance DocType unique index | 2025-11-08 | docs/03-INVENTORY/01-Inventory-Balance.md |
| OPEN: Define caching & invalidation strategy for theoretical inventory calculations | Performance optimization gap | Documentation calls for caching rather than recalculating every request, but exact strategy (e.g. Redis vs. DB materialization) is undecided | Without a decision, high-volume sites may see performance bottlenecks; needs resolution before large-scale consolidation. Status: Open question | Inventory transactions event model | 2025-11-08 | docs/03-INVENTORY/02-Theoretical-Inventory.md |

## Procurement & Integrations
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Allocate invoice lines to departments and convert to primary units before updating inventory | Receiving workflow | Chose department allocation + unit normalization instead of posting aggregate receipts to a single warehouse so theoretical inventory stays accurate | Procurement integrations (e.g. Ottimate) must supply department splits; consolidation with systems lacking that granularity requires enhancement. Status: Active | Product conversion methods; Inventory Balance updates | 2025-11-08 | docs/CROSS-DOMAIN-REFERENCE.md; docs/04-PROCUREMENT/README.md |
| Target Ottimate integration for invoice import | Stakeholder integration request | Selected Ottimate (existing hospitality AP tool) as first-class integration rather than custom manual entry to meet stakeholder expectations | Consolidation must decide whether to keep Ottimate as source of truth or replace with alternate AP feeds. Status: Planned | Ottimate API; Procurement DocTypes | 2025-11-08 | docs/04-PROCUREMENT/README.md; docs/DEVELOPMENT-GUIDE.md |

## Cross-Domain Patterns
| Decision | Context | Rationale | Impact | Depends On | Date | Source |
| --- | --- | --- | --- | --- | --- | --- |
| Require department-based filtering and permission checks in every domain query | Security & data isolation | Standardized pattern was chosen over domain-specific checks to guarantee consistent enforcement of department access | Consolidation with apps lacking department metadata must retrofit filters before merging. Status: Active | Department Permission service; shared query helpers | 2025-11-08 | docs/CROSS-DOMAIN-REFERENCE.md |
| Use shared patterns for unit conversion, inventory math, and permission checking across domains | Consistency enforcement | Centralized patterns prevent divergence between domains that would otherwise implement their own math or checks | Any incoming project code must adopt these helpers to avoid inconsistent results. Status: Active | Product conversion helpers; permission mixin; inventory services | 2025-11-08 | docs/CROSS-DOMAIN-REFERENCE.md |
| Enforce 2D Product + Department schema for reporting and analytics | Reporting alignment | Locked analytics onto the same 2D schema instead of introducing bespoke report dimensions to keep cross-domain insights aligned | Consolidation analytics must either adopt 2D or implement adapters to reconcile 3D/location-based data. Status: Active | Inventory balance; analytics domain plans | 2025-11-08 | docs/CROSS-DOMAIN-REFERENCE.md; docs/03-INVENTORY/README.md |


